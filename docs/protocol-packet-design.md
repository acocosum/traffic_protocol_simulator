# GB/T 43229-2023 协议数据包设计详解

## 协议概述

GB/T 43229-2023《交通信号控制机与车辆检测器间通信协议》规定了道路交通信号控制机与车辆检测器间通信的通则、信息格式、通信规程和消息内容。该协议适用于道路交通信号控制机与机动车检测器、非机动车检测器之间的通信。

### 通信模型

协议采用四层模型：
- **物理层**：支持以太网接口（10/100BASE-T全双工）或串行接口（RS-232/RS-422/RS-485）
- **网络层**：使用IP协议（以太网通信时）
- **传输层**：使用TCP或UDP协议，默认端口40000
- **应用层**：基于信息帧封装的数据表交换方式

### 通信角色

- **交通信号控制机**：作为服务端，负责查询和控制
- **车辆检测器**：作为客户端，负责检测和上报数据

## 信息帧整体结构

### 字节顺序约定

- **长度大于1字节的数值对象**：使用小端字节序，先发送低字节，后发送高字节
- **单个字节按位表示**：最高位（Bit7）在最左侧，最低位（Bit0）在最右侧
- **数字表示**：
  - 10进制：直接表示（如123）
  - 16进制：以"0x"为标识（如0x123）

### 信息帧结构图

```
+----------+----------+----------+----------+
|  帧开始  |  数据表  |  校验码  |  帧结束  |
|   0xC0   |   ...    | CRC16(2) |   0xC0   |
+----------+----------+----------+----------+
```

### 信息帧各部分说明

| 部分 | 长度 | 内容 | 说明 |
|------|------|------|------|
| 帧开始 | 1字节 | 0xC0 | 标识信息帧开始 |
| 数据表 | 可变 | 协议数据 | 包含具体的通信数据 |
| 校验码 | 2字节 | CRC16 | 对数据表进行校验 |
| 帧结束 | 1字节 | 0xC0 | 标识信息帧结束 |

## 信息帧各部分详解

### 帧开始和帧结束

- **取值**：0xC0
- **长度**：各1字节
- **功能**：标识信息帧的边界

### 校验码

- **算法**：CRC16
- **生成多项式**：X¹⁶+X¹⁵+X²+1
- **初始值**：0xFFFF
- **结果异或值**：0x0000
- **校验范围**：数据表的所有字节

### 数据转义机制

为避免数据内容与帧标识符冲突，需要进行数据转义：

| 原始字节 | 转义后 | 说明 |
|----------|--------|------|
| 0xC0 | 0xDB 0xDC | 避免与帧开始/结束冲突 |
| 0xDB | 0xDB 0xDD | 避免与转义标识符冲突 |

**转义规则**：
1. 在数据表或校验码中遇到0xC0时，替换为0xDB 0xDC
2. 在数据表或校验码中遇到0xDB时，替换为0xDB 0xDD

## 数据表结构详解

### 数据表整体结构

数据表由7个部分构成：

```
+----------+----------+----------+----------+----------+----------+----------+
| 链路地址 |发送方标识|接收方标识|协议版本  |操作类型  |对象标识  |消息内容  |
|  2字节   |  7字节   |  7字节   |  1字节   |  1字节   |  2字节   |  可变    |
+----------+----------+----------+----------+----------+----------+----------+
```

### 链路地址

- **长度**：2字节
- **取值**：0x0000（保留字段）
- **用途**：保留用于将来扩展

### 发送方标识 / 接收方标识

- **长度**：7字节
- **编制规则**：行政区划代码(3字节) + 设备类型(2字节) + 设备编号(2字节)

#### 行政区划代码

| 字节数 | 取值范围 | 说明 |
|--------|----------|------|
| 3 | 0~999999 | 6位数字，符合GB/T 2260规定 |

#### 设备类型（按位取值）

| 位 | 设备类型 |
|----|----------|
| Bit0 | 交通信号控制机 |
| Bit1 | 线圈检测 |
| Bit2 | 地磁检测 |
| Bit3 | 超声波检测 |
| Bit4 | 视频检测 |
| Bit5 | 微波断面检测 |
| Bit6 | 多目标雷达检测 |
| Bit7 | RFID检测 |
| Bit8~Bit15 | 保留 |

#### 设备编号

| 字节数 | 取值范围 | 说明 |
|--------|----------|------|
| 2 | 1~65535 | 设备唯一编号，广播时接收方取值65535(0xFFFF) |

### 协议版本

- **长度**：1字节
- **取值**：0x10
- **用途**：标识协议版本号

### 操作类型

- **长度**：1字节
- **格式**：Bit7固定为1，Bit6~0表示操作类型

| 二进制值 | 十六进制 | 含义 | 说明 |
|----------|----------|------|------|
| 10000000 | 0x80 | 查询请求 | 发送方发送查询消息 |
| 10000001 | 0x81 | 设置请求 | 发送方发送设置消息 |
| 10000010 | 0x82 | 主动上传 | 发送方主动上传数据 |
| 10000011 | 0x83 | 查询应答 | 接收方对查询请求的应答 |
| 10000100 | 0x84 | 设置应答 | 接收方对设置请求的应答 |
| 10000101 | 0x85 | 主动上传应答 | 接收方对主动上传的应答 |
| 10000110 | 0x86 | 出错应答 | 接收到的数据包存在错误 |

### 对象标识

- **长度**：2字节
- **用途**：标识数据表的操作对象

#### 主要对象标识

| 对象分类 | 对象名称 | 取值 | 说明 |
|----------|----------|------|------|
| 通信链路监测 | 通信连接 | 0x0101 | 通信链路建立与维护 |
| 设备管理 | 设备时间 | 0x0201 | 设备时间查询、上报与设置 |
| 设备管理 | 串口通信参数 | 0x0202 | 串口参数配置 |
| 设备管理 | 以太网通信参数 | 0x0203 | 网络参数配置 |
| 设备管理 | 检测器配置参数 | 0x0204 | 检测器配置 |
| 设备管理 | 检测器工作状态 | 0x0205 | 检测器状态信息 |
| 检测数据 | 交通流实时信息 | 0x0301 | 实时交通流数据 |
| 检测数据 | 交通流统计数据 | 0x0302 | 交通流统计数据 |
| 检测数据 | 交通流历史数据 | 0x0303 | 历史交通流数据 |
| 检测数据 | 通行状态实时信息 | 0x0401 | 实时通行状态 |
| 检测数据 | 通行状态统计数据 | 0x0402 | 通行状态统计数据 |
| 检测数据 | 通行状态历史数据 | 0x0403 | 历史通行状态数据 |
| 检测数据 | 车辆身份信息 | 0x0501 | 车辆身份识别信息 |
| 检测数据 | 异常事件信息 | 0x0601 | 交通异常事件 |
| 检测数据 | 异常事件历史数据 | 0x0602 | 历史异常事件 |
| 检测数据 | 非机动车检测实时信息 | 0x0701 | 实时非机动车检测 |
| 检测数据 | 非机动车检测统计数据 | 0x0702 | 非机动车统计数据 |
| 检测数据 | 非机动车检测历史数据 | 0x0703 | 历史非机动车数据 |

### 消息内容

- **长度**：可变
- **内容**：根据对象标识的不同，包含相应的数据结构
- **格式**：按照标准规范定义的具体格式

## 数据包示例

### 心跳查询数据包

交通信号控制机向车辆检测器发送心跳查询：

```
帧结构：0xC0 + 数据表 + CRC16 + 0xC0

数据表内容：
- 链路地址：        0x00 0x00
- 发送方标识：      0x01 0x86 0xA0 0x01 0x00 0x00 0x01  (110000+控制机+编号1)
- 接收方标识：      0x01 0x86 0xA0 0x02 0x00 0x00 0x01  (110000+检测器+编号1)
- 协议版本：        0x10
- 操作类型：        0x80  (查询请求)
- 对象标识：        0x01 0x01  (通信连接)
- 消息内容：        无

完整示例（未进行转义）：
0xC0 0x00 0x00 0x01 0x86 0xA0 0x01 0x00 0x00 0x01 0x01 0x86 0xA0 0x02 0x00 0x00 0x01 0x10 0x80 0x01 0x01 [CRC16] 0xC0
```

### 心跳查询应答数据包

车辆检测器对心跳查询的应答：

```
数据表内容：
- 链路地址：        0x00 0x00
- 发送方标识：      0x01 0x86 0xA0 0x02 0x00 0x00 0x01  (检测器)
- 接收方标识：      0x01 0x86 0xA0 0x01 0x00 0x00 0x01  (控制机)
- 协议版本：        0x10
- 操作类型：        0x83  (查询应答)
- 对象标识：        0x01 0x01  (通信连接)
- 消息内容：        无
```

### 交通流实时信息上传数据包

车辆检测器主动上传交通流实时信息：

```
数据表内容：
- 链路地址：        0x00 0x00
- 发送方标识：      0x01 0x86 0xA0 0x02 0x00 0x00 0x01  (检测器)
- 接收方标识：      0x01 0x86 0xA0 0x01 0x00 0x00 0x01  (控制机)
- 协议版本：        0x10
- 操作类型：        0x82  (主动上传)
- 对象标识：        0x03 0x01  (交通流实时信息)
- 消息内容：        交通流实时数据结构

消息内容示例：
- 实时数据生成时间： 0x61 0x3B 0x4E 0x65 0x00 0x00  (时间戳+毫秒)
- 检测通道数：       0x01  (1个通道)
- 通道1数据：
  - 检测通道编号：   0x01
  - 车辆数量：       0x05  (5辆车)
  - 车辆占有率：     0x1E  (30%)
  - 平均车速：       0x3C  (60 km/h)
  - 平均车头时距：   0x28  (4.0秒，以0.1秒计)
  - 其他字段...
```

### 设备时间设置数据包

交通信号控制机设置车辆检测器时间：

```
数据表内容：
- 链路地址：        0x00 0x00
- 发送方标识：      0x01 0x86 0xA0 0x01 0x00 0x00 0x01  (控制机)
- 接收方标识：      0x01 0x86 0xA0 0x02 0x00 0x00 0x01  (检测器)
- 协议版本：        0x10
- 操作类型：        0x81  (设置请求)
- 对象标识：        0x02 0x01  (设备时间)
- 消息内容：
  - 设备时间：       0x61 0x3B 0x4E 0x65 0x00 0x00  (地方时秒值+毫秒值)
  - 标准时差：       0x00 0x00 0x70 0x80  (时差秒值，东八区为28800秒)
```

## 错误处理机制

### 错误应答格式

当接收到错误的数据包时，发送错误应答：

```
- 操作类型：        0x86  (出错应答)
- 对象标识：        原始对象标识或全0
- 消息内容：
  - 错误类型：      1字节，错误类型码
```

### 错误类型定义

| 错误码 | 错误类型 | 说明 |
|--------|----------|------|
| 1 | 帧开始错误 | 未找到正确的帧开始标识 |
| 2 | 帧结束错误 | 未找到正确的帧结束标识 |
| 3 | 校验码错误 | CRC校验失败 |
| 4 | 链路地址错误 | 链路地址不符合规范 |
| 5 | 协议版本不兼容 | 协议版本不支持 |
| 6 | 操作类型错误 | 操作类型不支持 |
| 7 | 对象标识错误 | 对象标识不支持 |
| 8~127 | 用户自定义格式错误 | 其他消息格式错误 |
| 128 | 消息内容错误 | 消息内容格式错误 |
| 129~255 | 用户自定义内容错误 | 其他消息内容错误 |

### 超时处理

| 操作类型 | 超时时间 | 处理方式 |
|----------|----------|----------|
| 查询请求 | 3~5秒 | 查询失败，结束本次规程 |
| 设置请求 | 3~5秒 | 设置失败，结束本次规程 |
| 主动上传(有应答) | 3~5秒 | 上传失败，结束本次规程 |

### 连接状态监控

- **心跳间隔**：5秒
- **脱机判断**：控制机连续3次未收到检测器心跳应答
- **断线判断**：检测器超过15秒未收到控制机心跳查询

## 实现注意事项

### 数据处理要点

1. **字节序处理**：
   - 严格按照小端字节序发送多字节数据
   - 接收时正确转换字节序

2. **数据转义处理**：
   - 发送前对数据表和校验码进行转义
   - 接收后进行反转义操作
   - 注意转义序列的正确处理

3. **校验码计算**：
   - 使用标准CRC16算法
   - 确保初始值和多项式设置正确
   - 校验范围仅为数据表内容

### 通信管理建议

1. **连接管理**：
   - 实现连接状态机制
   - 处理连接建立和断开流程
   - 支持自动重连机制

2. **消息队列**：
   - 实现发送消息队列
   - 支持消息优先级
   - 处理消息重传机制

3. **并发控制**：
   - 合理控制消息发送频率
   - 避免消息冲突
   - 实现流量控制

### 性能优化建议

1. **缓存机制**：
   - 缓存常用的数据表结构
   - 预计算CRC校验表
   - 复用连接资源

2. **内存管理**：
   - 合理分配缓冲区大小
   - 及时释放临时内存
   - 避免内存泄漏

3. **网络优化**：
   - 使用TCP长连接
   - 实现连接池机制
   - 合理设置网络参数

### 调试支持

1. **日志记录**：
   - 记录所有通信消息
   - 包含时间戳和方向标识
   - 支持十六进制格式输出

2. **状态监控**：
   - 实时监控连接状态
   - 统计消息发送成功率
   - 记录错误和异常情况

3. **测试工具**：
   - 提供消息构造工具
   - 支持协议测试模式
   - 实现协议解析器

## 总结

GB/T 43229-2023协议是交通信号控制机与车辆检测器间通信的标准规范，具有以下特点：

### 协议特点

1. **结构清晰**：采用分层的信息帧结构，便于解析和处理
2. **可靠性高**：使用CRC16校验和数据转义机制，确保数据传输可靠性
3. **扩展性好**：支持多种设备类型和对象标识，便于功能扩展
4. **实时性强**：支持实时数据上传和查询应答机制

### 关键设计

1. **标准化标识**：使用行政区划代码和设备类型的组合标识设备
2. **灵活的消息类型**：支持查询、设置、主动上传等多种通信模式
3. **完善的错误处理**：定义了详细的错误类型和处理机制
4. **多样化的数据类型**：支持交通流、通行状态、车辆身份等多种数据

### 应用价值

1. **标准统一**：为交通检测设备提供了统一的通信标准
2. **互操作性**：不同厂商设备可以通过标准协议进行通信
3. **系统集成**：便于构建大规模的智能交通系统
4. **维护管理**：标准化的协议便于系统维护和管理

通过深入理解和正确实现该协议，可以构建稳定可靠的交通检测与控制系统，为智能交通建设提供技术支撑。